# Terrapod containerized test runner
# Usage: docker compose -f docker-compose.test.yml run --rm test
#    or: make test-python

services:
  localstack:
    image: localstack/localstack:4
    environment:
      SERVICES: s3
      DEFAULT_REGION: us-east-1
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:4566/_localstack/health | grep -q running"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: terrapod
      POSTGRES_PASSWORD: terrapod
      POSTGRES_DB: terrapod
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U terrapod"]
      interval: 3s
      timeout: 3s
      retries: 10

  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 3s
      retries: 10

  test:
    image: ${TEST_IMAGE:-terrapod-test:local}
    environment:
      TERRAPOD_STORAGE__BACKEND: "filesystem"
      TERRAPOD_STORAGE__FILESYSTEM__ROOT_DIR: "/tmp/terrapod-test-storage"
      TERRAPOD_LOG_LEVEL: "DEBUG"
      TERRAPOD_JSON_LOGS: "false"
      TERRAPOD_DATABASE_URL: "postgresql+asyncpg://terrapod:terrapod@postgres:5432/terrapod"
      TERRAPOD_REDIS_URL: "redis://redis:6379"
      LOCALSTACK_ENDPOINT: "http://localstack:4566"
      S3_TEST_BUCKET: "terrapod-test"
      AWS_ACCESS_KEY_ID: "test"
      AWS_SECRET_ACCESS_KEY: "test"
      AWS_DEFAULT_REGION: "us-east-1"
    depends_on:
      localstack:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  lint:
    image: ${TEST_IMAGE:-terrapod-test:local}
    command: >
      sh -c "ruff check . && ruff format --check ."
