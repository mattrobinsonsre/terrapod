name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Python ──────────────────────────────────────────────
  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: scripts/lint.sh python

  python-test:
    name: Python Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: scripts/test.sh python

  # ── Helm ────────────────────────────────────────────────
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Helm lint (containerized)
        run: |
          docker run --rm -v "$PWD:/chart" -w /chart \
            alpine/helm:3.17.2 \
            lint helm/terrapod --values helm/terrapod/values.yaml

  # ── Docker Build ────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build API image
        run: docker build -f docker/Dockerfile.api -t terrapod-api:ci .

  # ── Gate ────────────────────────────────────────────────
  ci-pass:
    name: CI
    if: always()
    needs:
      - python-lint
      - python-test
      - helm-lint
      - docker-build
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All checks passed"
